'use strict';

angular.module('insight.search').controller('SearchController',
    function ($scope, $routeParams, $location, $timeout, Global, Block, Transaction, Address, BlockByHeight, AssetsbyId) {
        $scope.global = Global;
        $scope.loading = false;

        var _badQuery = function () {
            $scope.badQuery = true;

            $timeout(function () {
                $scope.badQuery = false;
            }, 2000);
        };

        var _resetSearch = function () {
            $scope.q = '';
            $scope.loading = false;
        };

        $scope.search = function () {
            var q = $scope.q;
            $scope.badQuery = false;
            $scope.loading = true;
            if(q.length > 100){
                _badQuery();
                return;
            }
            getBlockByHash(q)
        }

        var getBlockByHash = function (q) {
            Block.get({
                blockHash: q
            }, function () {
                _resetSearch();
                $location.path('block/' + q);
            }, function () { //block not found, search on TX
                getTransaction(q);
            });
        };

        var getTransaction = function (q) {
            Transaction.get({
                txId: q
            }, function () {
                _resetSearch();
                $location.path('tx/' + q);
            }, function () { //tx not found, search on Address
                getAddress(q);
            });
        }

        var getAddress = function (q) {
            Address.get({
                addrStr: q
            }, function () {
                _resetSearch();
                $location.path('address/' + q);
            }, function () {// address not found
                getBlockByheight(q);
            });
        }

        var getBlockByheight = function (q) {
            BlockByHeight.get({
                blockHeight: q
            }, function (hash) {
                _resetSearch();
                if(q === '0') {
                    getAssetsById(q);
                }else{
                    $location.path('/block/' + hash.blockHash);
                }
            }, function () { // block by height not found
                getAssetsById(q);
            });
        }

        var getAssetsById = function (q) {
            AssetsbyId.get({
                assetsId: q
            }, function (assets) {
                _resetSearch();
                if(q.length == 64){
                    $location.path('/AssetsDetail/' + q);
                }else{
                    $location.path('/Assets/' + q);
                }
            }, function () {// assets not found
                if (isFinite(q)) { // ensure that q is a finite number. A logical height value.
                    $scope.loading = false;
                    _badQuery();
                } else {
                    $scope.loading = false;
                    _badQuery();
                }
            })
        }
    });