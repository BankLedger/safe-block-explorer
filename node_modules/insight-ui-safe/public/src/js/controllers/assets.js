'use strict';

angular.module('insight.assets').controller('AssetsController',
    function ($scope, $rootScope, $routeParams, $location, Global, AssetsList, AssetsbyId, getAssetsTranasction, getAssetsTxForAll) {
        var jumpPage = 0;
        var thisPage = 0;
        var displayLength = 7;     //分页的数量控制
        $scope.loading = true;
        $scope.maxPage = 1;

        $scope.list = function (page) { //默认显示所有
            if (page > $scope.maxPage) {
                return;
            } else if (page < 1) {
                return;
            } else if (thisPage == page) {
                return;
            }
            var name = $routeParams.name;
            thisPage = page;
            AssetsList.get({pageNum: page, name: name}, function (assets) {
                $scope.pageBut = [];
                $scope.pageButM = [];
                $scope.assets = assets.list;
                $scope.more = assets.more;
                $scope.maxPage = assets.maxPage;
                setPageButs(page, assets.maxPage, function (startPage, endPage) {
                    for (var i = startPage; i <= endPage; i++) {
                        $scope.pageBut.push({
                            num: i,
                            class: i == page ? "btn-default" : "btn-primary"
                        });
                        $scope.pageButM.push({
                            num: i,
                            class: i == page ? "click" : ""
                        });
                    }
                });
                $scope.loading = false;
                $scope.prePage = page - 1;
                $scope.nextPage = page + 1;
            })
        };

        function setPageButs(page, maxPage, cb) {
            var startPage = Math.round(page - displayLength / 2 + 1);
            var endPage = Math.round(page + displayLength / 2);
            if (startPage <= 1) {
                startPage = 1;
                endPage = startPage + displayLength - 1;
                if (endPage >= maxPage - 1) {
                    endPage = maxPage - 1;
                }
            }
            if (endPage >= maxPage - 1) {
                endPage = maxPage;
                startPage = maxPage - displayLength + 1;
                if (startPage <= 1) {
                    startPage = 1;
                }
            }
            cb(startPage, endPage);
        }

        $scope.findOne = function () {
            AssetsbyId.get({assetsId: $routeParams.assetsId}, function (assetsObj) {
                $scope.assets = assetsObj;
                $scope.id = $routeParams.assetsId;
                $scope.loading = false;
            })
        };

        $scope.$watch('jumpPage', function (page) {     //绑定控件元素值
            jumpPage = parseInt(page) || 0;
            if (jumpPage > $scope.maxPage) {
                window.document.getElementById("jumpInput").value = $scope.maxPage;
            } else if (jumpPage < 1) {
                if (window.document.getElementById("jumpInput")) {
                    window.document.getElementById("jumpInput").value = 1;
                }
            }
        });

        $scope.inputOnChange = function () {
            var page = window.document.getElementById("jumpInput").value;
            jumpPage = parseInt(page) || 0;
            if (jumpPage > $scope.maxPage) {
                window.document.getElementById("jumpInput").value = $scope.maxPage;
            } else if (jumpPage < 1) {
                if (window.document.getElementById("jumpInput")) {
                    window.document.getElementById("jumpInput").value = 1;
                }
            }
        };

        $scope.jumpPageBut = function (type) {  //分页
            if (jumpPage > 0 && thisPage != jumpPage) {
                if (jumpPage > $scope.maxPage) {
                    jumpPage = parseInt($scope.maxPage);
                }
                if (type == "list") {
                    $scope.list(jumpPage);
                } else if (type == "detail") {
                    $scope.getAssetsTxAllList(jumpPage);
                }
            }
        };


        $scope.ExpandedTxID = true;
        $scope.ExpandedAddr = true;
        $scope.ExpandedSpon = true;

        // 获取资产所有交易 ======================================================================
        $scope.getAssetsTxAllList = function (page) {
            if (page > $scope.maxPage) {
                return;
            } else if (page < 1) {
                return;
            } else if (thisPage == page) {
                return;
            }
            thisPage = page;

            $scope.loading = true;
            getAssetsTxForAll.get({
                assetsId: $routeParams.assetsId,
                page: page
            }, function (assetsTxObj) {
                $scope.pageBut = [];
                $scope.pageButM = [];
                $scope.maxPage = assetsTxObj.maxPage;
                setPageButs(page, assetsTxObj.maxPage, function (startPage, endPage) {
                    for (var i = startPage; i <= endPage; i++) {
                        $scope.pageBut.push({
                            num: i,
                            class: i == page ? "btn-default" : "btn-primary"
                        });
                        $scope.pageButM.push({
                            num: i,
                            class: i == page ? "click" : ""
                        });
                    }
                });
                $scope.assetsAllList = [];
                assetsTxObj.list.forEach(function (v) {
                    v.totalIssued = convertNum(v.totalIssued)
                });

                $scope.loading = false;
                $scope.assetsAllList = assetsTxObj.list;
                $scope.more = assetsTxObj.more;
                $scope.prePage = page - 1;
                $scope.nextPage = page + 1;
            })
        };

        function convertNum(amount) {
            // 判断是否科学计数法,是则进行转换
            var num = 0;
            var result = [];
            if ((amount.indexOf('E') != -1) || (amount.indexOf('e') != -1)) {
                (amount.indexOf('E') != -1) ? num = amount.indexOf('E') : num = amount.indexOf('e');
                var decimal = amount.substr(0, num);
                // devide the sentice efficial number
                var decArr = decimal.split('.', 2);
                // total 10 power
                var power = amount.substr(num + 1, amount.length);
                // symbol + -
                var symbol = power.substr(0, 1);
                power = power.substr(1, power.length);
                power = power * 1.0;
                if ('+' == symbol) {
                    // the number of 0 is power - decArr[1]
                    power = power - decArr[1].length;
                    // the return data
                    while (power > 0) {
                        result.unshift(0);
                        power -= 1;
                    }
                    result.unshift(decArr[1] * 1.0);
                    result.unshift(decArr[0] * 1.0);
                } else {
                    if (decArr[1]) {
                        power = power - decArr[1].length;
                    }
                    power--;
                    result = [0];
                    result.push('.');
                    while (power > 0) {
                        result.push(0);
                        power -= 1;
                    }
                    result.push(decArr);
                }
                result.join("");
                result = result + '';
                amount = result.replace(/,/g, '');
            }
            return amount;
        }
    });